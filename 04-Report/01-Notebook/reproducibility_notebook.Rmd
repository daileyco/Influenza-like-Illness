---
title: "Reproducibility Notebook"
output: html_notebook
---


# Project Overview

This repository / collection of scripts is a component of Cody Dailey's dissertation research. Altogether, the scope of this dissertation research spans the spatial epidemiology and evolution of seasonal influenza in the United States from 2010 to 2020. Here, I focus on an initial exploration of influenza-like illness incidence and seasonal epidemic intensity.   
  
> How do you eat an elephant?  
>   
>> One bite at a time.  
  
## Document Overview

This document is my "reproducibility notebook", basically, a data analyst's version of a lab notebook. It contains (hopefully) an easy-to-follow description of data management and analyses with associated scripts. My goal with this document is to ensure reproducibility in my research. Below, I will describe necessary steps in my workflow while sourcing various scripts to implement / execute this workflow. Note that this is supplemental information to the traditional scientific manuscript (which is found in another document) and will include much more technical details and analytical decisions / commentary. 



# Objective

* To explore variation in the incidence of influenza-like illness among USA states, DC, and Puerto Rico

* To assess the impact of population size and mobility / interconnectedness on epidemic intensity



# Approach

## Data Processing / Initial Cleaning

### Influenza-like Illness

ILI data from FluView and Florida Department of Public Health were processed using following script:

```{r}
source("./02-Scripts/01-Data-Wrangling/process_Data_ILI.R")
```


Data were stored in a dataframe with each row corresponding to a specific location (state) during a specific week (epi week and date) with the reported counts of ILI and total patients for that location during that week. 

Data were originally split for New York City and New York; I summed those to a single location. Also, data from FluView are missing Florida data completely, but LD was able to obtain data from the Florida Department of Public Health. The data greatly overlap, but the Florida data seems to be missing some of the earliest and latest data (effectively trimming the dataset from both timepoints ends). 





### Population Data

Next, we process some population estimates from the census. This is a simple script to extract a tidy df from a table in an excel spreadsheet: 

```{r}
source("./02-Scripts/01-Data-Wrangling/process_Data_Population.R", echo = T)
```



### Mobility Data

<!-- Worker commuting flows from the American Community Survey for both 2011-2015 and 2016-2020 are downloaded as excel spreadsheets, though not in a tidy data format (e.g., there is extra fluff at the top and bottom of the excel tables). The ACS data essentially contain four main variables: a location of residence, a location of work, a point estimate of the number of workers commuting between the two locations, and an estimate of uncertainty (i.e., margin of error) for the point estimate. These data are aggregated to the state level to align with the ILI data. In aggregating the data to the state level, the measure of uncertainty is lost; is there a simple way to account for each margin of error in aggregate data? For now, we will focus on the locations and the point estimate and potentially return to the uncertainty later for sensitivity analyses.    -->

<!-- The process script is simple enough as it just loads the data, categorizes the type of commuter flow (intracounty, intrastate, interstate, international), aggregates totals to the state level, combines the data from both time ranges, and then saves an .rds file. Additionally, the data are expanded to have entries for all possible combinations of locations; this allows me to note the "unobserved" flows.   -->

<!-- The script is sourced using the following code: -->

<!-- ```{r} -->
<!-- source("./02-Scripts/01-Data-Wrangling/process_Data_ACS.R", echo = T) -->
<!-- ``` -->


For ease and to not duplicate code, I am borrowing the clean data from the previous analysis (daileyco/Mobility-Models). This commuting data has the commuting flows between counties as well as the distances of each flow already computed. So, this data is merged with another dataset from the results of previous analysis. The results include the distance thresholds that were determined from gravity model fits. The county-to-county flow distances are compared to the distance thresholds for each region to categorize flows as internal (within resident county), short distance (less than or equal to distance threshold), and long distance (greater than distance threshold). These categories are then used to summarize the data at the state level by simple summation. This leaves a dataset with two entries for each state (two time periods) and quantities of the number of commutes of each "flow type" (according to distances). Following, these quantities are transformed in two ways. First, I take simple ratios of the total short distance commutes to the total internal commutes for each state. Similarly, I compute a ratio of the total long distance commutes to the total short distance commutes. These ratios I will use as predictors / independent variables. 



```{r}
source("./02-Scripts/01-Data-Wrangling/process_Data_ACS_Ratios_Aggregate.R", echo=T)
```









## Data Engineering

### ILI 

First, we will need to find the seasons for which we have complete data. Then for each season and each location, we need to sum the counts for cumulative season totals, and subsequently use them to calculate a proportion of cumulative season ILI totals observed in a given week. 

These proportions are used to calculate epidemic intensity, which is a slight modification of Shannon entropy across the weeks of an epidemic season. While Shannon entropy is maximized with balance across the categorical variable, i.e., week, epidemic intensity is inverted so that larger values correspond to more "intense" epidemics that are focused in a smaller time frame (larger peaks). Additionally, epidemic intensity is rescaled so that global minimum is zero and global maximum is one (global meaning across all seasons and regions in the dataset). 

Each new season begins in epidemiological week 40 (~October). ILI data for the Mariana Islands and Virgin Islands are dropped here as the former is missing all ILI data and neither are in the mobility data. For the weeks with zero counts of ILI, the individual week's epidemic intensity unit / entropy unit (i.e., p*log(p)) is indeterminate (log(0)) and replaced with a zero value. 

```{r}
source("./02-Scripts/01-Data-Wrangling/process_Data_ILI_Curve_Proportions.R", echo=TRUE)
```

In examining data missingness, I noted that the data values for the "year" are incorrect for week starts at end of December; for example, the year for the week start of 30 December 2012 is entered as 2013. Perhaps, this indicates the first epidemiological year similar to epiweeks? This was impacting data merging, so it was recomputed to reflect calendar year of the week start date. This year variable should not be needed for downstream analyses, though, but it was used for setting up data merges and examining implicitly missing data. 

Data are missing for Florida 2010-11 season completely, Puerto Rico 2010-11, 2011-12 seasons completely and nearly completely for 2012-13 season. The dataset is truncated at end of May for the 2020-21 season for all locations; likely artifact of download time. So, we will include data spanning from 2011-12 season to 2019-20 season, which matches the commuting data. Tentatively, PR will be included, but I will need to consider impact on analyses. 

Quick exploration of the distributions of the proportion of cumulative ILI (p) for each week for each location and what I am calling an epidemic intensity unit (ei.unit) (p*log(p)) indicates the intrinsic bounds at zero for both and at one for the proportions. So, in downstream analyses it may be preferable to use the ei unit over the proportion. Taking the absolute value of the ei unit flips the direction about zero so that values are non-negative and have a similar directional interpretation to the aggregate epidemic intensity; that is, larger values correspond to more extreme / imbalanced values (???). But, I am unsure of this being the best way for sake of interpretation. It may be a little wacky to treat the small and large values similarly, and maybe the proportions are preferable. 


### Population

The population estimates data roughly correspond to the population of a location at the midpoint (1 July) of the given year. This does not directly match up to the ILI data that have been transformed relative to seasonal totals where the season is set to begin at epiweek 40 of one year and ends at epiweek 39 of the following year. Note that this is more of a yearly designation rather than a true influenza season; a technical flu season may exclude summer months, May-ish through September-ish.  
  
To better align the the population estimate for a location at the midpoint of a given year to a specific influenza season, it may be useful to calculate simple averages between sequential years. For example, if I take the 2011 population estimate (July 1) and average it with the 2012 population estimate (July 1), then this may better correspond to the population size in December 2011 / January 2012, closer to the timing of the peaks of epidemics. 

The following script does that:

```{r}
source("./02-Scripts/01-Data-Wrangling/process_Data_Population_Align_Season.R", echo=TRUE)
source("./02-Scripts/01-Data-Wrangling/process_Data_Spatial.R", echo=TRUE)
```




### Commuting

<!-- The commuting data contains information about the commuter flow volume or flux between two locations. In this way, it it really data on the connectedness / adjacency of location pairs, a network. In this format, it is not easily combined or aligned with the ILI data. Sure there may be some network analyses or compartmental modeling analyses that we could perform to use the data in its original format, but, here, I only want to do some simple analyses relating the ILI epidemic intensity. A rudimentary approach could be to include all origins and destinations and their flows as separate variables or features, e.g., number of incoming commuters from Georgia. However, this may present a few problems: (1) there will be many implicit "zeros" where location pairs have no commuters; (2) there will be many many variables (52 incoming + 52 outgoing?); (3) this would not allow for a more "generalized" interpretation as all features are specific to single locations. So, another approach is desirable. The simplest way that I can think to initially approach this analysis is to aggregate the commuter flows in three ways: (1) internal commutes where origins and destinations are the same; (2) all incoming / inflow commuters for a specific destination location; (3) all outgoing / outflow commuters for a specific origin location. In this way, we will have features corresponding to local population mixing (internal), potential importations (incoming), and potential "foreign" exposures (outgoing). This is still rather rudimentary, but it will work for this preliminary analysis.   -->

<!-- One last thing to consider is the scale of the data. As I am hoping to analyze this data alongside the population size data, the counts of commuter volume may be too correlated with the population size; that is, large counts of population size will correspond to large numbers of commuters. To remove this relationship, I need to account for the population sizes. Another simple approach may be to compute the proportions of commuters for each category. Though, this may force us to drop one of the three categories. (idk how to best describe this loss of a degree of freedom, linear combination; if they're not internal or outgoing, then they must be incoming?) So, another simple approach could be to calculate the proportions of commuters that are incoming (foreign, bad word choice but it works) or outgoing (expats, bad word choice but it works). Then, I could treat the internal commuters a little differently. This is a little challenging to decide on. My initial thoughts were to just to calculate the proportion of the total population that is an internal commuter. Part of me wants to consider the number of counties as well, though.  -->

<!-- I went back to the original processing script where the data were aggregated to the state level and created a variable categorizing the flow type as either intracounty, intrastate (but not intracounty), interstate, and international. With this new level of aggregation, I can now calculate the proportions of workers in a focal resident location who are (1) outgoing (expats), (2) incoming (foreign), and (3) commuting within the state between counties. I realized that it may be preferable to exclude the workers who work in the same county as they reside and having an additional category would allow me to use the simple proportions. Though, this may introduce a bias according to the number of counties and their relative size (Eastern US has more and smaller counties than Western US). I'm just going to rock with this as is for now and think more on how to control later (maybe somehow take the distance of the flow into consideration). -->

<!-- The following script aggregates the commuting data:   -->

<!-- ```{r} -->
<!-- source("./02-Scripts/01-Data-Wrangling/process_Data_ACS_Aggregate_Flows.R", echo=TRUE) -->
<!-- ``` -->



<!-- Maybe in the future, I can bridge the gap between the two aforementioned approaches, such as with features corresponding to the specific flows within and among different regions.  -->


## Finalize Dataset

The following script merges the epidemic intensity dataset, the population dataset, and the commuting dataset. Also, all three separate and the newly merged dataset are packaged (saved) together. 

```{r}
source("./02-Scripts/01-Data-Wrangling/process_Data_Final_Dataset.R", echo=TRUE)
```




## Analysis: Variation in Influenza-like Illness Epidemic Intensity against Population Size and Commuting Patterns

Now, that the data have been managed and set up for this analysis, we can look at the data more closely and set up some hypothesis tests. 



### Data Presentation / Visualization

We can first create some nice figures to show the data. 


```{r}
source("./02-Scripts/03-Visualization/generate_Tables_Summary.R")
```





#### Epidemic Curves Heatmap

The following script creates a heatmap to represent the ILI epidemic curves, or rather the proportions of cumulative ILI cases for each season, for each location across the data time frame:

```{r}
source("./02-Scripts/03-Visualization/generate_Figure_ILI_Epidemic_Curves_Heatmap.R", echo=TRUE)
```



#### Epidemic Intensities


The following script creates a table showing the epidemic intensities for each location and each season:


```{r}
source("./02-Scripts/03-Visualization/generate_Table_Epidemic_Intensities.R")
source("./02-Scripts/03-Visualization/generate_Figure_ILI_Epidemic_Intensity_Heatmap.R")
```


##### Epidemic Intensity Scatter Plots against Covariates

The following script creates a figure of four scatter plots, epidemic intensity vs population size, proportion of commutes that are international, interstate, and intrastate but between counties: 

edited to proportions of internal (intracounty), short distance, and long distance, with added plots for ratios of short:internal and long:short.


```{r}
source("./02-Scripts/03-Visualization/generate_Figure_Epidemic_Intensity_Scatters.R")
source("./02-Scripts/03-Visualization/generate_Figures_MapEICommutes.R")
```



## Explaining Epidemic Intensity Variation

For the sake of simplicity, we will only focus on the relationship between epidemic intensity, population size, and population mobility, similar to the scatter plots created in previous figure. 

The following script fits a linear regression of epidemic intensity against the natural logartihm of population size, the proportion of commutes that are international, the proportion of commutes that are interstate, the proportion of commutes that are intrastate but intercounty, and an indicator for season:

```{r}
source("./02-Scripts/04-Analysis/regress_Epidemic_Intensity.R")
```

The script also creates a summary table for the model coefficients. 




```{r}
source("./02-Scripts/03-Visualization/generate_Figures_Scatters_w_Fits.R")
source("./02-Scripts/03-Visualization/generate_Flextables_Coefs.R")
```



Now, I draft. 


